name: Docker Build and Test

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

env:
  ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'main' || 'dev' }}

jobs:
  backend-build-test:
    name: Backend Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dotnet tools
        run: dotnet tool restore

      - name: Check code formatting
        run: dotnet csharpier --check .

      - name: Restore dependencies
        run: dotnet restore

      - name: Build backend
        run: dotnet build --no-restore --configuration Release

      - name: Run unit tests
        run: dotnet test tests/Dashyboard.UnitTests/Dashyboard.UnitTests.csproj --no-build --configuration Release --verbosity normal

      - name: Run integration tests
        run: dotnet test tests/Dashyboard.IntegrationTests/Dashyboard.IntegrationTests.csproj --no-build --configuration Release --verbosity normal

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/Dockerfile
          tags: dashyboard-backend:${{ github.sha }}
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Save backend Docker image
        if: github.ref == 'refs/heads/main'
        run: |
          docker save dashyboard-backend:${{ github.sha }} | gzip > backend.tar.gz

      - name: Upload backend artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: backend-image
          path: backend.tar.gz
          retention-days: 7

  frontend-build-test:
    name: Frontend Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Lint frontend
        working-directory: frontend
        run: npm run lint

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          tags: dashyboard-frontend:${{ github.sha }}
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Save frontend Docker image
        if: github.ref == 'refs/heads/main'
        run: |
          docker save dashyboard-frontend:${{ github.sha }} | gzip > frontend.tar.gz

      - name: Upload frontend artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-image
          path: frontend.tar.gz
          retention-days: 7

  integration-test:
    name: Integration Test (Full Stack)
    runs-on: ubuntu-latest
    needs: [backend-build-test, frontend-build-test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set environment label
        run: |
          echo "Building for ${{ env.ENVIRONMENT }} environment"

      - name: Build all services
        run: |
          docker compose build

      - name: Start services
        run: |
          docker compose up -d

      - name: Wait for services to start
        run: |
          echo "Waiting for services to be ready..."
          sleep 15

      - name: Check Frontend
        run: |
          curl -f http://localhost:3000 || exit 1
          echo "‚úÖ Frontend is running"

      - name: Check Backend API
        run: |
          curl -f http://localhost:5000 || echo "‚ö†Ô∏è  Backend responded (health endpoint may not exist yet)"

      - name: Verify all containers running
        run: |
          docker compose ps
          echo "‚úÖ All services built and started successfully"

      - name: View logs on failure
        if: failure()
        run: |
          docker compose logs

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v

  deploy:
    name: Deploy to Environment
    runs-on: ubuntu-latest
    needs: [integration-test]
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://dashyboard.example.com

    steps:
      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-image

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-image

      - name: Load Docker images
        run: |
          docker load < backend.tar.gz
          docker load < frontend.tar.gz

      - name: Tag images for deployment
        run: |
          docker tag dashyboard-backend:${{ github.sha }} dashyboard-backend:latest
          docker tag dashyboard-frontend:${{ github.sha }} dashyboard-frontend:latest

      - name: Deploy to server
        run: |
          echo "üöÄ Deployment steps would go here"
          echo "Example: Push to container registry, update Kubernetes, etc."
          echo "Images ready: dashyboard-backend:latest and dashyboard-frontend:latest"
